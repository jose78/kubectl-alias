from diagrams import Diagram, Cluster, Edge
from diagrams.aws.compute import EC2, EKS
from diagrams.aws.network import ELB, VPC, PrivateSubnet, PublicSubnet
from diagrams.aws.general import APIGateway
from diagrams.aws.management import SystemsManager
from diagrams.aws.security import SecretsManager
from diagrams.aws.storage import S3
from diagrams.aws.devtools import CodeBuild
from diagrams.aws.ml import Sagemaker
from diagrams.aws.integration import Eventbridge
from diagrams.aws.database import ElastiCache
from diagrams.aws.network import VPCEndpoint

with Diagram("AWS Infra - VPC-08a Layout", show=True, direction="TB"):
    
    with Cluster("VPC-08a"):
        
        # API Gateway redirige a NLB-1
        api_gw = APIGateway("API Gateway")

        # Endpoints
        with Cluster("VPC Endpoints"):
            endpoints = [
                VPCEndpoint("ssm"),
                VPCEndpoint("secretsmanager"),
                VPCEndpoint("s3-gateway"),
                VPCEndpoint("s3-interface"),
                VPCEndpoint("execute-api"),
                VPCEndpoint("elasticcache"),
                VPCEndpoint("ec2"),
                VPCEndpoint("ecr.api"),
                VPCEndpoint("ecr.dkr"),
                VPCEndpoint("sts")
            ]

        # NLBs
        with Cluster("Load Balancers"):
            nlb1 = ELB("nlb-1")
            nlb2 = ELB("nlb-2")
            nlb3 = ELB("nlb-3")
            nlb4 = ELB("nlb-4")

        api_gw >> nlb1  # redirección

        # Subnets y Node Group
        with Cluster("EKS Cluster (eks-1)"):
            with Cluster("Node Group (2 AZs - subnets 107.x)"):
                ec2_1 = EC2("m5.2xlarge")
                ec2_2 = EC2("m5.2xlarge")
                ec2_3 = EC2("m5.2xlarge")
            eks = EKS("eks-1")
            eks - [ec2_1, ec2_2, ec2_3]

        # Conexiones desde los NLBs al EKS
        for nlb in [nlb1, nlb2, nlb3]:
            nlb >> eks

        # Agrupamos subnets lógicamente
        with Cluster("Subnets (CIDR grouped)"):
            PrivateSubnet("10.x (6)")
            PublicSubnet("180.x (2)")
            PublicSubnet("107.x (2 - AZs)")

        # Route Tables
        with Cluster("Route Tables"):
            Edge(label="Default")  # no subnet association
            Edge(label="10.x Associated")
            Edge(label="180.x / 107.x Associated")

